---
title: "Capstone"
author: "Vinh"
date: "`r Sys.Date()`"
output: 
  word_document:
    fig_width: 10
    fig_height: 6
editor_options: 
  markdown: 
    wrap: 72
---

# 

```{r setup}
knitr::opts_chunk$set(warning = TRUE)

```

# **Phần 1. Gọi packages và đọc dữ liệu**

```{r message = FALSE}
library(tidyverse)
library(janitor)
library(gtsummary)
library(skimr)
library(scales)
df <- read_csv("E:/R-Together/day1/data/life-exp.csv")
```

# **Phần 2. Khám phá dữ liệu**

## 2.1. Xem và nhận xét dữ liệu

```{r message = FALSE}
skimr::skim(df)
```

-   Dữ liệu có bao nhiêu dòng và bao nhiêu cột? Number of rows 1649\
    Number of columns 22

-   Dữ liệu gồm những loại biến nào? Column type frequency:\
    character 2\
    numeric 20

-   Dữ liệu có cột nào có missing không? Nếu có thì gồm những cột nào?
    Không có missing\
    \## 2.2. Đổi tên các biến

-   Tên các cột có đúng quy tắc chưa? Nếu chưa thì đổi tên cột theo đúng
    quy tắc. Quy tắc Tên ngắn Không có khoảng trắng (thay thế bằng dấu
    gạch dưới\_) Không có ký tự lạ (&, #, \<, \>, …) Thống nhất cách
    định danh

```{r}
names(df)
df <- clean_names(df)
names(df)
```

## 2.3. Xoay trục dữ liệu

```{r}
df <- df %>%
  pivot_longer(
    cols = starts_with("thinness"),
    names_to = "age_group",
    values_to = "thinness"
  )
```

# Phần 3. Xử lý và phân tích dữ liệu

## 3.1. Sử dụng df truy xuất ra những cột Measles, Polio, Diphtheria và gán thành df_diseases. Sau đó in kết quả những dòng đầu tiên

```{r}
df_diseases <- df %>% select(measles, polio, diphtheria)
head(df_diseases)
```

## 3.2. Sử dụng df truy xuất hàng 2, cột 5.

```{r}
a <- df[2, 5]
a
```

## 3.3. Sử dụng df truy nhất hàng 2,5 và cột Measles, Polio.

```{r}
b <- df[c(2, 5), c("measles", "polio")]
b
```

## 3.4. Thay thế những giá trị missing của cột Life Expectancy bằng giá trị trung bình của những giá trị

```{r}
table(is.na(df$life_expectancy))
df <- df %>%
  mutate(life_expectancy = ifelse(
    is.na(life_expectancy),
    mean(life_expectancy, na.rm = TRUE),
    life_expectancy
  ))
```

## 3.5. Tạo 1 data frame chứa 2 đối tượng top_5 và bot_5 và gán thành df_top_bot

```{r}
# 5 quốc gia có tuổi thọ trung bình cao nhất năm 2015
top_5 <- df %>%
  filter(year == 2015) %>%
  distinct(country, .keep_all = TRUE) %>%   # Loại trùng lặp quốc gia
  slice_max(order_by = life_expectancy, n = 5, with_ties = T)

# 5 quốc gia có tuổi thọ trung bình thấp nhất năm 2015
bot_5 <- df %>%
  filter(year == 2015) %>%
  distinct(country, .keep_all = TRUE) %>%
  slice_min(order_by = life_expectancy, n = 5, with_ties = FALSE)

  # Tạo 1 data frame chứa 2 đối tượng top_5 và bot_5 và gán thành df_top_bot
df_top_bot <- bind_rows(top_5, bot_5)
head(df_top_bot)
```

## 3.6. Tạo biến mới bmi_lv là biến thứ tự gồm các nhóm: dưới 18.5, từ 18.5 đến 23, trên 23

```{r}
df <- df %>% mutate(bmi= case_when(
  bmi < 18.5 ~ "Dưới 18.5",
  bmi >= 18.5 & bmi <= 23 ~ "Từ 18.5 đến 23",
  bmi > 23 ~ "Trên 23",
  TRUE ~ NA_character_) # Nếu bị thiếu dữ liệu
  )
```

## 3.7. Sử dụng df nhóm theo country để tính trung bình GDP và gán thành df_gdp_by_country

```{r}
df_gdp_by_country <- df %>%
  group_by(country) %>%
  summarise(mean_gdp = mean(gdp, na.rm = TRUE))
```

# **Phần 4: Tạo bảng thống kê năm 2015**

Nhập lại dữ liệu

```{r,include=FALSE}
df <- read_csv("E:/R-Together/day1/data/life-exp.csv")
# làm sạch, định dạng kiểu dữ liệu
df<- clean_names(df) %>%
  mutate(
    bmi = as.numeric(bmi),
    life_expectancy = as.numeric(life_expectancy),
    adult_mortality = as.numeric(adult_mortality),
    gdp = as.numeric(gdp),
    schooling = as.numeric(schooling)
  )
```

## Tạo bảng kết quả

```{r}
tbl <- df %>%
  select(status, life_expectancy, adult_mortality, gdp, schooling, bmi) %>%
  tbl_summary(
    by = status,
    label = list(
      life_expectancy ~ "**Tuổi thọ**",
      adult_mortality ~ "**Tử vong người lớn**",
      gdp ~ "**GDP**",
      schooling ~ "**Đi học**",
      bmi ~ "**BMI**"
    ),
    missing = "no",
    statistic = c(
      all_continuous() ~ "{mean} [{min}-{max}]",
      bmi ~ "{median} ({p25}-{p75})"
    )) %>%  
  add_overall() %>%
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) %>%
  bold_labels() %>%
  modify_caption("**Bảng mô tả các đặc trưng theo Status**")
# In bảng kết quả
tbl
```

# Phần 5. Trực quan hoá dữ liệu

## 5.1. Plot 1

-   Chuẩn bị data

```{r}
plot5 <- df %>%
  select(country, life_expectancy, year) %>%
  filter(country %in% c("Belgium","Germany", "Thailand", "Cambodia")) %>%
  group_by(country, year)
```

-   Vẽ biểu đồ

```{r}
ggplot(plot5, aes(x = year, y = life_expectancy, color = country)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_x_continuous(
    limits = c(2000, 2015),             # Giới hạn trục x từ 2000 đến 2015
    breaks = seq(2000, 2015, by = 3)    # Nhãn năm cách nhau mỗi 3 năm
  ) +
  labs(
    title = "Xu hướng tuổi thọ trung bình theo năm",
    x = "Năm",
    y = "Tuổi thọ (năm)",
    color = "Quốc gia"
  ) +
  theme_minimal(base_size = 14)
```

## 5.2. Plot 2

-   Chuẩn bị data

```{r}
df_sub <- df %>%
  filter(country %in% c("Belgium","Germany", "Thailand", "Cambodia")) %>%
  filter(gdp > 0)
```

-   Vẽ biểu đồ

```{r}
ggplot(df_sub, aes(
  x = gdp, 
  y = life_expectancy, 
  color = status, 
  size = population/1e6
)) +
  geom_point(alpha = 0.8) +
  scale_x_log10(labels = dollar_format()) +
  scale_color_manual(
    name = "Tình trạng phát triển",
    values = c("Developed" = "#d7263d", "Developing" = "#009688")
  ) +
  scale_size_continuous(
    name = "Dân số (triệu người)",
    range = c(2, 10)
  ) +
  facet_wrap(~ country, ncol = 2, strip.position = "top") +
  labs(
    title = "Mối liên hệ giữa GDP và tuổi thọ trung bình (4 quốc gia)",
    x = "GDP (USD, log10)",
    y = "Tuổi thọ (năm)"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    strip.text = element_text(face = "bold", size = 15, color = "#333"),
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, color = "#20232a"),
    legend.position = "right",
    legend.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(linetype = "dashed", color = "grey80"),
    panel.grid.minor = element_blank()
  )
```

# Phần 6. Function

```{r}
plot_country <- function(df, country_name, indicator) {
  # Kiểm tra country_name có trong df không
  if (!(country_name %in% unique(df$country))) {
    stop("Tên quốc gia không tồn tại trong dữ liệu!")
  }
  # Kiểm tra indicator có trong df không
  if (!(indicator %in% names(df))) {
    stop("Chỉ số không tồn tại trong dữ liệu!")
  }
  
  df_sub <- df %>%
    filter(country == country_name) %>%
    filter(gdp > 0)
  
  p <- ggplot(df_sub, aes(
    x = gdp, 
    y = .data[[indicator]],     # Truy xuất biến động
    color = status, 
    size = population / 1e6
  )) +
    geom_point(alpha = 0.8) +
    scale_x_log10(labels = dollar_format()) +
    scale_color_manual(
      name = "Tình trạng phát triển",
      values = c("Developed" = "#d7263d", "Developing" = "#009688")
    ) +
    scale_size_continuous(
      name = "Dân số (triệu người)",
      range = c(2, 10)
    ) +
    labs(
      title = paste("Mối liên hệ giữa GDP và", indicator, "của", country_name),
      x = "GDP (USD, log10)",
      y = indicator
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(face = "bold", size = 18, hjust = 0.5, color = "#20232a"),
      legend.position = "right",
      legend.background = element_rect(fill = "white", color = NA),
      panel.grid.major = element_line(linetype = "dashed", color = "grey80"),
      panel.grid.minor = element_blank()
    )
  
  print(p)
}
```

Ví dụ

```{r}
plot_country(df, "Australia", "schooling")
```
